#!/usr/bin/env node --max_old_space_size=4096

'use strict';

var fs = require('graceful-fs');
var path = require('path');
var tilebelt = require('tilebelt');
var normalizer = require('../lib/normalize-ways');
var argv = require('minimist')(process.argv.slice(2));

var outputPath = argv.outputPath;
var waysFile = argv.waysFile;
var zoomLevel = argv.zoomLevel;

normalizer.createQuadkeyWaysHash(waysFile, zoomLevel, function (err, quadHash) {
  if (err) throw err;

  Object.keys(quadHash).forEach(function (quadkey) {
    var tile = tilebelt.quadkeyToTile(quadkey);
    var ways = quadHash[quadkey];
    ways = normalizer.normalizeWays(ways, tile);

    fs.writeFile(path.join(outputPath, quadkey + '.json'), ways.map(function (way) {
      // append quadkey to way id
      way.properties.id = way.properties.id + ';' + quadkey;
      return JSON.stringify(way);
    }).join('\n'));
  });
});
